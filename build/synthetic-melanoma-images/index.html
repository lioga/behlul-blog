<!doctype html>
<html lang="en-US">
  <head prefix="og: https://ogp.me/ns#">
    <meta charset="utf-8" />
    <meta name="generator" content="gh:importantimport/urara" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" crossorigin="use-credentials" href="/manifest.webmanifest" />
    <link rel="alternate" type="application/feed+json" href="/feed.json" />
    <link rel="alternate" type="application/atom+xml" href="/atom.xml" />
    <link rel="sitemap" type="application/xml" href="/sitemap.xml" />
    <meta http-equiv="content-security-policy" content="style-src 'self' 'unsafe-inline' https://giscus.app">
		<link href="../_app/immutable/assets/0.4658d976.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.bff7916a.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/scheduler.9b9e513e.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/singletons.938ed84b.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/index.834d9e00.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.bb691d3d.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/preload-helper.a4192956.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/index.781c9930.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.e8904407.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/posts.80c9a437.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/icon.90dd3d0a.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/6.8e47cf65.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/post_layout.0e908408.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/footer.066404e2.js"><title>Medical Image Synthesis with SDXL | Behlul Akbudak</title><!-- HEAD_svelte-1592q3p_START --><!-- HEAD_svelte-1592q3p_END --><!-- HEAD_svelte-1kxdj3d_START --><link rel="shortcut icon" href="https://behlulakbudak.com/favicon.png" sizes="48x48" type="image/png"><link rel="apple-touch-icon" href="https://behlulakbudak.com/assets/any@180.png" sizes="180x180" type="image/png"><link rel="icon" href="https://behlulakbudak.com/assets/any@192.png" sizes="192x192" type="image/png"><!-- HEAD_svelte-1kxdj3d_END --><!-- HEAD_svelte-1g590ms_START --><meta name="theme-color"><!-- HEAD_svelte-1g590ms_END --><!-- HEAD_svelte-abrfj_START --><meta name="author" content="Behlul Akbudak"><link rel="canonical" href="https://behlulakbudak.com/synthetic-melanoma-images">  <meta name="keywords" content="Stable-Diffusion, Medical, Image-Synthesis"> <meta name="description" content="How I Synthesized Medical Melanoma Images with Stable Diffusion and LoRa"><!-- HEAD_svelte-abrfj_END --><!-- HEAD_svelte-4dky5b_START --><meta property="og:site_name" content="Behlul Akbudak"><meta property="og:locale" content="en-US"><meta property="og:type" content="article"> <meta property="og:title" content="Medical Image Synthesis with SDXL"> <meta property="og:description" content="How I Synthesized Medical Melanoma Images with Stable Diffusion and LoRa"> <meta property="og:image" content="https://behlulakbudak.com/assets/maskable@512.png"> <meta name="twitter:card" content="summary"> <meta property="article:tag" content="Stable-Diffusion"><meta property="article:tag" content="Medical"><meta property="article:tag" content="Image-Synthesis"> <meta property="og:url" content="https://behlulakbudak.com/synthetic-melanoma-images"> <meta property="article:author" content="Behlul Akbudak"> <meta property="article:published_time" content="2023-11-02T00:00:00.000Z"> <meta property="article:modified_time" content="2023-11-02T00:00:00.000Z"><!-- HEAD_svelte-4dky5b_END -->
  </head>
  <body itemscope itemtype="https://schema.org/WebPage">
    <div style="display: contents">      <header id="header" class="fixed z-50 w-full transition-all duration-500 ease-in-out border-b-2 border-transparent max-h-[4.125rem] false"><div class="navbar"><div class="navbar-start">  <div class="dropdown lg:hidden"><label for="navbar-dropdown" tabindex="0" class="btn btn-square btn-ghost" data-svelte-h="svelte-rz1qrs"><span class="i-heroicons-outline-menu-alt-1"></span></label> <ul id="navbar-dropdown" tabindex="0" class="menu menu-compact dropdown-content bg-base-100 text-base-content shadow-lg rounded-box min-w-max max-w-52 p-2"><li><a href="/">Home</a> </li><li><a href="/about">About</a> </li></ul></div> <div class="swap order-last hidden lg:inline-grid"><button class="swap-on btn btn-ghost text-base font-normal normal-case transition-all duration-200 hidden"></button> <ul class="swap-off menu menu-horizontal p-0"><li><a class="!rounded-btn" href="/">Home</a> </li><li><a class="!rounded-btn" href="/about">About</a> </li></ul></div> <a href="/" class="btn btn-ghost normal-case text-lg">Behlul Akbudak</a></div> <div class="navbar-end"> <div id="change-theme" class="dropdown dropdown-end">  <div tabindex="0" class="btn btn-square btn-ghost" data-svelte-h="svelte-1qtp8cz"><span class="i-heroicons-outline-color-swatch"></span></div>   <ul tabindex="0" class="flex flex-nowrap shadow-2xl menu dropdown-content bg-base-100 text-base-content rounded-box w-52 p-2 gap-2 overflow-y-auto max-h-[21.5rem]"><button data-theme="cupcake" class="btn btn-ghost w-full hover:bg-primary group rounded-lg flex bg-base-100 p-2 transition-all"><p class="flex-1 text-left text-base-content group-hover:text-primary-content transition-color">Light</p> <div class="grid grid-cols-4 gap-0.5 m-auto"><div class="bg-primary w-1 h-4 rounded-btn"></div><div class="bg-secondary w-1 h-4 rounded-btn"></div><div class="bg-accent w-1 h-4 rounded-btn"></div><div class="bg-neutral w-1 h-4 rounded-btn"></div></div> </button><button data-theme="dracula" class="btn btn-ghost w-full hover:bg-primary group rounded-lg flex bg-base-100 p-2 transition-all"><p class="flex-1 text-left text-base-content group-hover:text-primary-content transition-color">Dark</p> <div class="grid grid-cols-4 gap-0.5 m-auto"><div class="bg-primary w-1 h-4 rounded-btn"></div><div class="bg-secondary w-1 h-4 rounded-btn"></div><div class="bg-accent w-1 h-4 rounded-btn"></div><div class="bg-neutral w-1 h-4 rounded-btn"></div></div> </button><button data-theme="night" class="btn btn-ghost w-full hover:bg-primary group rounded-lg flex bg-base-100 p-2 transition-all"><p class="flex-1 text-left text-base-content group-hover:text-primary-content transition-color">Night</p> <div class="grid grid-cols-4 gap-0.5 m-auto"><div class="bg-primary w-1 h-4 rounded-btn"></div><div class="bg-secondary w-1 h-4 rounded-btn"></div><div class="bg-accent w-1 h-4 rounded-btn"></div><div class="bg-neutral w-1 h-4 rounded-btn"></div></div> </button><button data-theme="valentine" class="btn btn-ghost w-full hover:bg-primary group rounded-lg flex bg-base-100 p-2 transition-all"><p class="flex-1 text-left text-base-content group-hover:text-primary-content transition-color">valentine</p> <div class="grid grid-cols-4 gap-0.5 m-auto"><div class="bg-primary w-1 h-4 rounded-btn"></div><div class="bg-secondary w-1 h-4 rounded-btn"></div><div class="bg-accent w-1 h-4 rounded-btn"></div><div class="bg-neutral w-1 h-4 rounded-btn"></div></div> </button></ul></div></div></div></header> <button id="totop" aria-label="scroll to top" class="fixed grid group btn btn-circle btn-lg border-none backdrop-blur bottom-6 right-6 z-50 duration-500 ease-in-out btn-ghost bg-base-100/30 md:bg-base-200/30 translate-y-24"><div class="radial-progress text-accent transition-all duration-500 ease-in-out group-hover:text-accent-focus col-start-1 row-start-1" style="--size:4rem; --thickness: 0.25rem; --value:undefined;"></div> <div class="border-4 border-base-content/10 group-hover:border-transparent col-start-1 row-start-1 rounded-full w-full h-full p-4 grid duration-500 ease-in-out" data-svelte-h="svelte-hwvjh5"><span class="i-heroicons-solid-chevron-up !w-6 !h-6"></span></div></button> <div class="bg-base-100 md:bg-base-200 min-h-screen pt-16 md:pb-8 lg:pb-16">  <div class="flex flex-col flex-nowrap justify-center xl:flex-row xl:flex-wrap"><div class="flex-1 w-full order-first ease-out transform mx-auto xl:mr-0 xl:ml-0"></div> <div class="flex-1 w-full xl:order-last ease-out transform mx-auto xl:ml-0 xl:mr-0"></div> <div class="flex-none w-full max-w-screen-md mx-auto xl:mx-0"><article itemscope itemtype="https://schema.org/BlogPosting" itemprop="blogPost" class="h-entry card bg-base-100 rounded-none md:rounded-box md:shadow-xl overflow-hidden z-10 md:mb-8 lg:mb-16">   <div class="card-body gap-0 "><div class="flex flex-col gap-2"> <div class="flex font-semibold gap-1.5"><a rel="author" class="opacity-75 hover:opacity-100 hover:text-primary duration-500 ease-in-out p-author h-card" href="https://behlulakbudak.com">Behlul Akbudak</a> <span class="opacity-50" data-svelte-h="svelte-1edzios">/</span> <a href="/synthetic-melanoma-images" class="u-url u-uid swap group/time"><time class="group-hover/time:opacity-0 font-semibold opacity-75 duration-500 ease-in-out mr-auto dt-published" datetime="2023-11-02T00:00:00.000Z" itemprop="datePublished">Thursday, Nov 2, 23</time> <time class="opacity-0 group-hover/time:opacity-100 font-semibold text-primary duration-500 ease-in-out mr-auto dt-updated" datetime="2023-11-02T00:00:00.000Z" itemprop="dateModified">Thursday, Nov 2, 23</time></a></div> <h1 itemprop="name headline" class="card-title text-3xl mb-8 p-name">Medical Image Synthesis with SDXL</h1> <p itemprop="description" class="p-summary mb-auto hidden">How I Synthesized Medical Melanoma Images with Stable Diffusion and LoRa</p></div> <main itemprop="articleBody" class="urara-prose prose e-content"><p data-svelte-h="svelte-76dcdd">In this blog post, I will explain how I fine-tuned the “Stable Diffusion” with limited resources to generate synthetic malignant melanoma images. The goal of this project was to demonstrate that we can address class imbalance in medical datasets by generating synthetic data, ultimately enabling the training of more robust deep learning models.
Melanoma
We will talk about:</p> <ul data-svelte-h="svelte-ci61g1"><li>Brief information about melanoma, role of synthetic data for augmenting rare medical images</li> <li>Quick overview of medical image synthesis</li> <li>Brief introduction to stable diffusion, what is new in SDXL</li> <li>Fine-tuning techniques for SDXL, comparison between them</li> <li>Preparing medical skin dataset and fine-tuning SD with LoRa</li> <li>Results and discussion</li></ul> <h1 id="melanoma-skin-cancer" data-svelte-h="svelte-l7r8fl"><a href="#melanoma-skin-cancer">Melanoma Skin Cancer</a></h1> <p data-svelte-h="svelte-1xq9gil">Melanoma, a form of skin cancer, arises when melanocytes, the cells responsible for skin pigmentation, undergo uncontrolled growth. This condition is a result of cells in the body losing control over their growth, a hallmark of cancer that can occur in various parts of the body and potentially spread to distant regions.</p> <p data-svelte-h="svelte-19id2xe">In many cases, melanoma cells continue to produce melanin, leading to tumors with brown or black pigmentation. However, some melanomas do not synthesize melanin, causing them to exhibit pink, tan, or even white coloration.</p> <p data-svelte-h="svelte-e3yany">Melanomas have the potential to develop anywhere on the skin, though they display a higher likelihood of originating on the trunk (chest and back) in men and on the legs in women. It’s important to note that having darkly pigmented skin does reduce the risk of developing melanoma at the more common sites. However, it’s crucial to emphasize that <strong>anyone</strong>, including individuals with darker skin, can indeed develop melanoma on the palms of their hands, the soles of their feet, or beneath their nails.</p> <h2 id="melanoma-in-people-of-color" data-svelte-h="svelte-omv6yk"><a href="#melanoma-in-people-of-color">Melanoma in People of Color</a></h2> <p data-svelte-h="svelte-z8e84b">It’s worth highlighting that melanoma diagnoses in Black individuals tend to occur at later stages, increasing the risk of severe cases. Darker skin contains a higher number of melanocytes, the pigment-producing cells that offer some level of protection against sun-induced skin damage, including the kind that leads to skin cancer. Darker skin is less prone to sunburn, which has sometimes led to the misconception that Black individuals are immune to skin cancer.</p> <p data-svelte-h="svelte-1pjk3el">This misconception can result in a lack of skin self-examinations for cancer, delayed medical consultations for skin changes. Moreover, even artificial intelligence systems designed to assist in early cancer detection may fail to adequately identify melanoma on darker skin if they lack a diverse dataset, including representative samples of individuals with darker skin tones.</p> <p data-svelte-h="svelte-1iyjich">To address this disparity, the use of synthetic data can play a valuable role in expanding the available data for melanoma detection in Black populations, improving diagnostic accuracy, and ultimately ensuring that all individuals, regardless of their skin tone, receive the appropriate care and attention in the fight against melanoma<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>.</p> <h2 id="key-indicators-of-melanoma" data-svelte-h="svelte-1gtbi8s"><a href="#key-indicators-of-melanoma">Key Indicators of Melanoma</a></h2> <p data-svelte-h="svelte-wypfys">Finding melanoma at an early stage is crucial; early detection can vastly increase your chances for cure. The first five letters of the alphabet are a guide to help you recognize the warning signs of melanoma. <strong>A is for Asymmetry</strong>, <strong>B is for Border</strong>, <strong>C is for Color</strong>, <strong>D is for Diameter or Dark</strong>, and <strong>E is for Evolving</strong>. More information can be found <a href="https://www.skincancer.org/skin-cancer-information/melanoma/melanoma-warning-signs-and-images/" rel="nofollow noopener noreferrer external" target="_blank">here</a>.</p> <center data-svelte-h="svelte-13el4n1"><img src="img/melanoma_detection.webp" alt="key indicators" width="430"></center> <h1 id="medical-image-synthesis" data-svelte-h="svelte-6e6w1w"><a href="#medical-image-synthesis">Medical Image Synthesis</a></h1> <p data-svelte-h="svelte-1y9bpgj">In the history of medical image synthesis, data scarcity in healthcare has driven the usage of generative models like Generative Adversarial Networks (GANs)<sup id="fnref-2"><a href="#fn-2" class="footnote-ref">2</a></sup> and Variational Autoencoders (VAEs). GANs use a competitive game between a generator and discriminator to create increasingly realistic synthetic data, while VAEs learn a probabilistic mapping to balance data fidelity and diversity in their generated samples. You can find lots of resources on internet about how they work.</p> <p data-svelte-h="svelte-t2t6j3">GANs are powerful but troubled by learning instability, convergence issues, and mode collapse. On the other hand, VAEs excel in output diversity and avoid mode collapse, but often produce blurry and hazy images. Recent advances, such as denoising diffusion probabilistic models (DDPMs) and latent DDPMs, have outperformed other techniques in generating natural images. Thus, their performance in medical image synthesis is a current research topic.</p> <p data-svelte-h="svelte-1gxu2y">So, we will be exploring the capabilities of diffusion models, with a special focus on a particular model called the “Stable Diffusion”. This model has gained acclaim for its proficiency in generating highly realistic images.</p> <h1 id="stable-diffusion" data-svelte-h="svelte-emq2ou"><a href="#stable-diffusion">Stable Diffusion</a></h1> <p data-svelte-h="svelte-5xnk0t">Basically, Stable Diffusion is a text-to-image model that takes a prompt for input and then outputs an image that corresponds to that. First, they take input data and progressively introduce Gaussian noise in a controlled manner, creating a sort of “noisy” version of the data. This process is like a delicate recipe for noise creation. Then, the real power of these models comes into play. They are trained to reverse this diffusion process, effectively removing the noise and returning clean data from the initially noisy samples.</p> <center data-svelte-h="svelte-28zbkm"><img src="img/sd_arch.webp" alt="sd" width="480"></center>
I don&#39;t want to deep dive into how Stable Diffusion works but there are great resources that I can suggest for you:
<ul data-svelte-h="svelte-16lzsga"><li><a href="https://jalammar.github.io/illustrated-stable-diffusion/" rel="nofollow noopener noreferrer external" target="_blank">Jay Alammar</a> explains diffusion models and what is happening behind the stable diffusion with illustrations.</li> <li>You can check <a href="https://lilianweng.github.io/posts/2021-07-11-diffusion-models/" rel="nofollow noopener noreferrer external" target="_blank">Lilian Weng</a> if you want to learn math behind SD.</li> <li>What you are looking for is more practical knowledge, then SD <a href="https://www.reddit.com/r/StableDiffusion/" rel="nofollow noopener noreferrer external" target="_blank">subreddit</a> is way to go. You can find practical tips and more resources to get started.</li></ul> <p data-svelte-h="svelte-4nptg8">SDXL is the latest version of the stable diffusion. To highlight the differences from the previous version of SD, here’s a concise list:</p> <ul data-svelte-h="svelte-nsxr31"><li>Larger UNet backbone (three times larger)</li> <li>Increased model parameters with more attention blocks</li> <li>Introduction of a second text encoder</li> <li>Training on multiple aspect ratios</li> <li>Addition of a refinement model for improving visual fidelity</li></ul> <p data-svelte-h="svelte-12f7wfc">So, it’s undoubtedly more powerful and capable of generating fantastic results with even shorter prompts.</p> <h1 id="fine-tuning-methods-for-sd" data-svelte-h="svelte-1mnrtt0"><a href="#fine-tuning-methods-for-sd">Fine-tuning Methods for SD</a></h1> <p data-svelte-h="svelte-48hwb">Training large foundation models like Stable Diffusion from scratch is a formidable task due to their massive computational requirements, extended training times, and complex data needs. So, training these massive models from scratch is a pretty daunting task.</p> <p data-svelte-h="svelte-1952n39">That’s why many folks in the field are going for a more practical option. Instead of building everything from the ground up, they’re fine-tuning existing pretrained models. It’s a smart move because it saves time and resources and still gets you impressive results. However, there is not a single way to fine tune SD models.</p> <h4 id="traditional-naive-fine-tuning-nft" data-svelte-h="svelte-1piw1pi"><a href="#traditional-naive-fine-tuning-nft"><strong>Traditional Naive Fine-tuning (NFT)</strong></a></h4> <p data-svelte-h="svelte-zov7rk">This is classic fine-tuning for neural networks. Naive Fine-tuning neural networks means adjusting a pre-trained model for a new task, capitalizing on its prior knowledge while making it more suitable for the specific problem at hand. It alters the original model weights. New model can adapt highly specific use cases without prompt engineering.</p> <p data-svelte-h="svelte-1mdkr6y">However this process requires very large dataset, in terms of SD I recommend minimum dataset size of 1000, and you have to create complex captions for that dataset. Compared to other fine-tuning methods, this technique requires more training steps.</p> <h4 id="dreambooth" data-svelte-h="svelte-b2cs75"><a href="#dreambooth">Dreambooth</a></h4> <p data-svelte-h="svelte-15g3c30">Dreambooth<sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup> approach is for “personalization” of text-to-image diffusion models. By providing a few reference images of a subject, the model fine-tunes itself to connect a unique identifier to that specific subject. Then, when you give it a text prompt, it can generate a range of lifelike images, each one capturing the essence of the subject, all while being versatile and creative in different contexts. More info can be found <a href="https://huggingface.co/blog/dreambooth" rel="nofollow noopener noreferrer external" target="_blank">here</a>.</p> <p data-svelte-h="svelte-1af92ux">For Dreambooth training you need to have a dataset of thing you want to train on also you need a regularization dataset. Regularization is used for making the model more robust for over-fitting. However, I have seen some folks that are not using it and still got great results. So, it is a bit trial and error with your dataset, which I think the most important aspect of training, and hyperparameter tuning such as finding a sweet spot for learning rate.</p> <h4 id="lora" data-svelte-h="svelte-2l2n58"><a href="#lora">LoRa</a></h4> <p data-svelte-h="svelte-1lltydh">LoRA<sup id="fnref-4"><a href="#fn-4" class="footnote-ref">4</a></sup> (Low-Rank Adaptation) is a novel technique that originally invented for fine-tuning large-language models. It retains the pre-trained model’s core while incorporating trainable rank decomposition matrices into each layer of the Transformer architecture. This strategic move significantly reduces the number of parameters requiring fine-tuning and, notably, alleviates the GPU memory burden.</p> <p data-svelte-h="svelte-duhhst">LoRA focuses on the cross-attention layers on the model, where textual and visual elements intersect. Researchers have found that by fine-tuning this specific aspect of the model, LoRA can achieve remarkable results, making it a compelling choice for optimizing large language models across a range of real-world tasks and applications. In order to train a LoRa, you need images of the subject and corresponding captions for them.</p> <h2 id="comparison" data-svelte-h="svelte-6sjifx"><a href="#comparison">Comparison</a></h2> <p data-svelte-h="svelte-an45qf">There are also other methods such as textual-inversion and hypernetworks. However, I think their performance are not suitable for medical image synthesizing. So, I will not mention them in this post. Also some people combine some methods together, for example, Dreambooth with textual inversion or LoRa training with Dreambooth style. I haven’t tried those myself so I don’t have any recommendations about that.</p> <h4 id="computational-perspective" data-svelte-h="svelte-69yijm"><a href="#computational-perspective">Computational Perspective</a></h4> <p data-svelte-h="svelte-1cdzlvm">If we compare these 3 methods in terms of computational intensity: Traditional Fine-tuning &gt; Dreambooth &gt; LoRa. You’ll require an A100 or a graphics card with at least 24GB of VRAM for the traditional approach. LoRa and Dreambooth, on the other hand, can be trained with 16GB of VRAM. With further optimization, it’s possible to train these methods on machines with 8-12GB of VRAM.</p> <h4 id="size-on-disk" data-svelte-h="svelte-1dodknv"><a href="#size-on-disk">Size on Disk</a></h4> <p data-svelte-h="svelte-s1d1v7">In terms of size, LoRa is the smallest among them. It is only 200 - 600MB in size generally. Other methods alters the original model and saves the whole weights. So they are bigger and take up few gigabytes on disk. This factor becomes important when you want to train different subjects or iterate over same subject with different parameters.</p> <h4 id="why-i-chose-lora" data-svelte-h="svelte-17nvmz"><a href="#why-i-chose-lora">Why I Chose LoRa</a></h4> <p data-svelte-h="svelte-gxerft">I chose to use LoRa for this task for some compelling reasons. First, LoRa is lightweight in terms of system requirements, and you can train it even with a free-tier Google Colab using a T4 GPU, making it accessible. It’s also speedy to train because it doesn’t alter the model’s original weights and focuses on a smaller set of parameters. Moreover, LoRa is much smaller in size. It is significantly smaller than traditional checkpoints. Given these advantages, I decided to test the performance of SDXL combined with LoRa in the field of medical imaging.</p> <h4 id="fine-tuning-based-on-your-goal" data-svelte-h="svelte-xq211c"><a href="#fine-tuning-based-on-your-goal">Fine-tuning Based on Your Goal</a></h4> <p data-svelte-h="svelte-1xojtvl">Ultimately, regardless of the chosen method, the specific aim you pursue determines the duration of training, the requisite hyperparameters, and the size of your dataset. The nature of what you aim to teach the model significantly influences these parameters. For instance, teaching a simple character might demand only 10-100 photos, while introducing intricate details in inference such as wings, requires more images and specific hyperparameters to match. Similarly, teaching a distinct style, like a self-created style such as ”<em>behlulism</em>,” necessitates a more extensive dataset.</p> <p data-svelte-h="svelte-1g51nla">In the case of medical images, the need for comprehensive data becomes apparent—gathering all available data becomes crucial for effective training in this domain. Because the base model knows nothing about it and you have to teach that concept. You might wonder, “Why fine-tune the model when it knows nothing about the subject I want to teach?” Well, in this approach, the magic lies in the pretrained weights. They equip the model not just with knowledge of your subject but also with a powerful understanding of what distinctly <em>isn’t</em> your subject.</p> <h1 id="data-preparation" data-svelte-h="svelte-1l2bw8r"><a href="#data-preparation">Data Preparation</a></h1> <p data-svelte-h="svelte-yn09n2">The dataset was generated by the International Skin Imaging Collaboration ISIC<sup id="fnref-5"><a href="#fn-5" class="footnote-ref">5</a></sup> and they hosted a competition on Kaggle. In this competition, there were very few melanoma images compared to a ton of healthy ones – just 584 melanoma images and 32,542 healthy ones. To tackle this imbalance, the winning team had to bring in last year’s competition dataset because there simply weren’t enough melanoma images available<sup id="fnref-6"><a href="#fn-6" class="footnote-ref">6</a></sup>.</p> <center data-svelte-h="svelte-1idxobw"><img src="img/melanoma_samples.webp" alt="samples from dataset" width=""></center> <p data-svelte-h="svelte-1tit0uw">I wanted to use this dataset for fine-tuning SD with LoRa. In order to do that, I need to extract melanoma images from the dataset and also I have to create captions for that images. In CSV file, there is information about the name of the image, gender of the patient, age, and if the mole is malignant or not. I used that information for separating malignant images and captioning them.</p> <p data-svelte-h="svelte-zq1wi1">To start, I created a simple script that scans the <em>‘train.csv’</em> file to identify the malignant melanoma images and extracts them. After separating malignant images, I created another simple script for captioning:</p> <!-- HTML_TAG_START --><pre class="shiki material-default" style="background-color: #263238; color: #EEFFFF" python="true"><div class="language-id">python</div><div class='code-container'><code><div class='line'><span style="color: #C792EA">def</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">create_caption</span><span style="color: #89DDFF">(</span><span style="color: #EEFFFF">row</span><span style="color: #89DDFF">):</span></div><div class='line'><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">"""</span><span style="color: #546E7A">Create a caption for an image.</span><span style="color: #89DDFF">"""</span></div><div class='line'><span style="color: #EEFFFF">    sex </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> row</span><span style="color: #89DDFF">[</span><span style="color: #F78C6C">2</span><span style="color: #89DDFF">]</span></div><div class='line'><span style="color: #EEFFFF">    anatom_site </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> row</span><span style="color: #89DDFF">[</span><span style="color: #F78C6C">4</span><span style="color: #89DDFF">]</span></div><div class='line'><span style="color: #EEFFFF">    age </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> row</span><span style="color: #89DDFF">[</span><span style="color: #F78C6C">3</span><span style="color: #89DDFF">]</span></div><div class='line'><span style="color: #EEFFFF">    benign_malignant </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> row</span><span style="color: #89DDFF">[</span><span style="color: #F78C6C">6</span><span style="color: #89DDFF">]</span></div><div class='line'><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">if</span><span style="color: #EEFFFF"> benign_malignant</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">lower</span><span style="color: #89DDFF">()</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">==</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">'</span><span style="color: #C3E88D">malignant</span><span style="color: #89DDFF">'</span><span style="color: #89DDFF">:</span></div><div class='line'><span style="color: #EEFFFF">        sex_caption </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> sex </span><span style="color: #89DDFF">or</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">""</span></div><div class='line'><span style="color: #EEFFFF">        anatom_site_caption </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #C792EA">f</span><span style="color: #C3E88D">"on </span><span style="color: #EEFFFF">&#123;anatom_site&#125;</span><span style="color: #C3E88D">"</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">if</span><span style="color: #EEFFFF"> anatom_site </span><span style="color: #89DDFF">else</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">""</span></div><div class='line'><span style="color: #EEFFFF">        age_caption </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #C792EA">f</span><span style="color: #C3E88D">", at age </span><span style="color: #EEFFFF">&#123;</span><span style="color: #FFCB6B">int</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">age</span><span style="color: #89DDFF">)</span><span style="color: #EEFFFF">&#125;</span><span style="color: #C3E88D">"</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">if</span><span style="color: #EEFFFF"> age </span><span style="color: #89DDFF">else</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">""</span></div><div class='line'><span style="color: #EEFFFF">        caption </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #C792EA">f</span><span style="color: #C3E88D">"photo of </span><span style="color: #EEFFFF">&#123;sex_caption&#125;</span><span style="color: #C3E88D"> skin, melanoma </span><span style="color: #EEFFFF">&#123;anatom_site_caption&#125;&#123;age_caption&#125;</span><span style="color: #C3E88D">"</span></div><div class='line'><span style="color: #EEFFFF">        </span><span style="color: #89DDFF">return</span><span style="color: #EEFFFF"> caption</span></div><div class='line'><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">else</span><span style="color: #89DDFF">:</span></div><div class='line'><span style="color: #EEFFFF">        </span><span style="color: #89DDFF">return</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">None</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-9e45zs">I utilized the data within the CSV file to generate diverse captions based on gender, age, and the anatomical site. Because I wanted more variation in captions, I created a script that analyzes if there is hair in the image.</p> <!-- HTML_TAG_START --><pre class="shiki material-default" style="background-color: #263238; color: #EEFFFF" python="true"><div class="language-id">python</div><div class='code-container'><code><div class='line'><span style="color: #C792EA">def</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">process_image</span><span style="color: #89DDFF">(</span><span style="color: #EEFFFF">image_path</span><span style="color: #89DDFF">):</span></div><div class='line'><span style="color: #EEFFFF">	</span><span style="color: #89DDFF">"""</span><span style="color: #546E7A">Analyze the images if they are hairy or not.</span><span style="color: #89DDFF">"""</span></div><div class='line'><span style="color: #EEFFFF">    </span><span style="color: #546E7A"># Load the image</span></div><div class='line'><span style="color: #EEFFFF">    image </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> cv2</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">imread</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">image_path</span><span style="color: #89DDFF">)</span></div><div class='line'><span style="color: #EEFFFF">    </span><span style="color: #546E7A"># Convert the image to grayscale</span></div><div class='line'><span style="color: #EEFFFF">    gray_image </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> cv2</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">cvtColor</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">image</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> cv2</span><span style="color: #89DDFF">.</span><span style="color: #F07178">COLOR_BGR2GRAY</span><span style="color: #89DDFF">)</span></div><div class='line'><span style="color: #EEFFFF">    </span><span style="color: #546E7A"># Apply Gaussian blur to reduce noise and improve contour detection</span></div><div class='line'><span style="color: #EEFFFF">    blurred_image </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> cv2</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">GaussianBlur</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">gray_image</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> </span><span style="color: #89DDFF">(</span><span style="color: #F78C6C">5</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> </span><span style="color: #F78C6C">5</span><span style="color: #89DDFF">),</span><span style="color: #82AAFF"> </span><span style="color: #F78C6C">0</span><span style="color: #89DDFF">)</span></div><div class='line'><span style="color: #EEFFFF">    </span><span style="color: #546E7A"># Use Canny edge detection to find edges in the image</span></div><div class='line'><span style="color: #EEFFFF">    edges </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> cv2</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">Canny</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">blurred_image</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> </span><span style="color: #F78C6C">50</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> </span><span style="color: #F78C6C">250</span><span style="color: #89DDFF">)</span></div><div class='line'><span style="color: #EEFFFF">    </span><span style="color: #546E7A"># Find contours in the edge image</span></div><div class='line'><span style="color: #EEFFFF">    contours</span><span style="color: #89DDFF">,</span><span style="color: #EEFFFF"> _ </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> cv2</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">findContours</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">edges</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> cv2</span><span style="color: #89DDFF">.</span><span style="color: #F07178">RETR_EXTERNAL</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> cv2</span><span style="color: #89DDFF">.</span><span style="color: #F07178">CHAIN_APPROX_SIMPLE</span><span style="color: #89DDFF">)</span></div><div class='line'><span style="color: #EEFFFF">    </span><span style="color: #546E7A"># Define a minimum contour length threshold to filter out small artifacts</span></div><div class='line'><span style="color: #EEFFFF">    min_contour_length </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #F78C6C">100</span><span style="color: #EEFFFF">  </span></div><div class='line'><span style="color: #EEFFFF">    </span><span style="color: #546E7A"># Filter out small contours (artifacts)</span></div><div class='line'><span style="color: #EEFFFF">    filtered_contours </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">[</span><span style="color: #EEFFFF">contour </span><span style="color: #89DDFF">for</span><span style="color: #EEFFFF"> contour </span><span style="color: #89DDFF">in</span><span style="color: #EEFFFF"> contours </span><span style="color: #89DDFF">if</span><span style="color: #EEFFFF"> cv2</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">arcLength</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">contour</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> </span><span style="color: #89DDFF">False)</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">&gt;=</span><span style="color: #EEFFFF"> min_contour_length</span><span style="color: #89DDFF">]</span></div><div class='line'><span style="color: #EEFFFF">    total_perimeter </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #F78C6C">0</span></div><div class='line'><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">for</span><span style="color: #EEFFFF"> contour </span><span style="color: #89DDFF">in</span><span style="color: #EEFFFF"> filtered_contours</span><span style="color: #89DDFF">:</span></div><div class='line'><span style="color: #EEFFFF">        perimeter </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> cv2</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">arcLength</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">contour</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> </span><span style="color: #89DDFF">False)</span></div><div class='line'><span style="color: #EEFFFF">        total_perimeter </span><span style="color: #89DDFF">+=</span><span style="color: #EEFFFF"> perimeter</span></div><div class='line'><span style="color: #EEFFFF">    </span><span style="color: #82AAFF">print</span><span style="color: #89DDFF">(</span><span style="color: #C792EA">f</span><span style="color: #C3E88D">'Total Perimeter: </span><span style="color: #82AAFF">&#123;total_perimeter&#125;</span><span style="color: #C3E88D">'</span><span style="color: #89DDFF">)</span></div><div class='line'><span style="color: #EEFFFF">    name_of_caption </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> image_path</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">split</span><span style="color: #89DDFF">(</span><span style="color: #89DDFF">"</span><span style="color: #C3E88D">.</span><span style="color: #89DDFF">"</span><span style="color: #89DDFF">)</span></div><div class='line'><span style="color: #EEFFFF">    </span><span style="color: #546E7A"># If the total perimeter is greater than 4000, add ', hairy' to the caption</span></div><div class='line'><span style="color: #EEFFFF">    </span><span style="color: #89DDFF">if</span><span style="color: #EEFFFF"> total_perimeter </span><span style="color: #89DDFF">&gt;</span><span style="color: #EEFFFF"> </span><span style="color: #F78C6C">4000</span><span style="color: #89DDFF">:</span></div><div class='line'><span style="color: #EEFFFF">        </span><span style="color: #546E7A"># Add ', hairy' to the caption file associated with this image</span></div><div class='line'><span style="color: #EEFFFF">        caption_filename </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> name_of_caption</span><span style="color: #89DDFF">[</span><span style="color: #F78C6C">0</span><span style="color: #89DDFF">]</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">+</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">'</span><span style="color: #C3E88D">.caption</span><span style="color: #89DDFF">'</span></div><div class='line'><span style="color: #EEFFFF">        </span><span style="color: #89DDFF">with</span><span style="color: #EEFFFF"> </span><span style="color: #82AAFF">open</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">caption_filename</span><span style="color: #89DDFF">,</span><span style="color: #82AAFF"> </span><span style="color: #89DDFF">'</span><span style="color: #C3E88D">a</span><span style="color: #89DDFF">'</span><span style="color: #89DDFF">)</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">as</span><span style="color: #EEFFFF"> file</span><span style="color: #89DDFF">:</span></div><div class='line'><span style="color: #EEFFFF">            text_to_add </span><span style="color: #89DDFF">=</span><span style="color: #EEFFFF"> </span><span style="color: #89DDFF">'</span><span style="color: #C3E88D">, hairy</span><span style="color: #89DDFF">'</span></div><div class='line'><span style="color: #EEFFFF">            file</span><span style="color: #89DDFF">.</span><span style="color: #82AAFF">write</span><span style="color: #89DDFF">(</span><span style="color: #82AAFF">text_to_add</span><span style="color: #89DDFF">)</span></div></code></div></pre><!-- HTML_TAG_END --> <p data-svelte-h="svelte-1rzvdbf">I think the code is quite self explanatory. Essentially, it identifies edge counters in the images, summing them up to compare against a predefined threshold to determine if there’s sufficient hair in the image. When hair is detected, it appends a “hairy” caption to the existing files. It’s worth noting that the script is experimental and not without its imperfections, mainly because of the dynamic nature of medical images. That’s why I decided to keep it separate from the original captioning script.</p> <p data-svelte-h="svelte-3mvhc">Finally, the created captions will be in the format of:
photo of a (sex) skin, me1anoma on (anatom_site), at age (age_approx), (hairy).</p> <h1 id="fine-tuning-sd-with-lora" data-svelte-h="svelte-sffwxn"><a href="#fine-tuning-sd-with-lora">Fine-tuning SD with LoRa</a></h1> <p data-svelte-h="svelte-1hrj7xy">For fine-tuning purposes, I employed the scripts available from <a href="https://github.com/kohya-ss/sd-scripts" rel="nofollow noopener noreferrer external" target="_blank">kohya_ss</a>. Alternatively, you can also use the <a href="https://github.com/huggingface/diffusers/" rel="nofollow noopener noreferrer external" target="_blank">diffusers</a> library from Hugging Face. The kohya_ss repository offers various versions and experimental models, making it worth exploring.</p> <h2 id="base-model" data-svelte-h="svelte-1sejxow"><a href="#base-model">Base Model</a></h2> <p data-svelte-h="svelte-f9edud">To begin with, LoRa necessitates a base model for training. There are two approaches regarding the choice of base model. Some people advocate consistently using standard checkpoints (pretrained model weights) like SD 1.5 or SDXL 1.0. Others suggest selecting a checkpoint aligned with your specific objectives. For example, if your aim is to generate highly realistic images of the character you’re training on, a specialized checkpoint with a focus on realism, such as the one provided <a href="https://civitai.com/models/152525/realism-engine-sdxl" rel="nofollow noopener noreferrer external" target="_blank">here</a>, should be your choice. On the other hand, if you want to create anime-like images, a base model specialized for anime generation is preferable.</p> <p data-svelte-h="svelte-18q42j4">Both approaches make sense, and your choice really depends on what you’re trying to achieve. If you want to transfer yourself or a real world person into the world of SD, then those checkpoints with a focus on realism are great because they understand how real people look and give you a head start while fine-tuning. However, if you want to capture a specific style or something unique, like medical images, it’s better to go with base models like SDXL 1.0 or SD 1.5. They’re less biased towards any specific outcome.</p> <h2 id="note-on-beauty-standards-of-models" data-svelte-h="svelte-14j0ks0"><a href="#note-on-beauty-standards-of-models">Note on Beauty Standards of Models</a></h2> <p data-svelte-h="svelte-f8oh7c">I want to highlight that these models often aim to produce images that align with what are considered ‘stereotypical beauty standards’, focusing on achieving ‘perfect’ body and facial features. During my experimentation with these models and fine-tuning processes, I wanted to transfer my girlfriend to the world of SD. She has a beautiful feature, a charming nasal hump on her nose. However, when generating images, we often struggled to retain this nasal hump in the resulting images because the model tends to prioritize conforming to these conventional beauty norms. In response to this, there are even checkpoints available that specifically aim to depict more natural <a href="https://civitai.com/models/98755/humans" rel="nofollow noopener noreferrer external" target="_blank">humans</a>.</p> <center data-svelte-h="svelte-17jryi"><img src="img/loratestresult.webp" alt="lora results" width=""></center> <p data-svelte-h="svelte-50z69l"><em>One of the best resuls we achieved; left real right synthetic</em></p> <p data-svelte-h="svelte-dd9pxj">I’d love to delve deeper into this topic and explore the biases in these models, for example race and gender discrimination is hugely biased in these models, but that would be a whole new blog subject. In the meantime, you can check out <a href="https://www.bloomberg.com/graphics/2023-generative-ai-bias/" rel="nofollow noopener noreferrer external" target="_blank">this article</a>.</p> <h2 id="training-configs" data-svelte-h="svelte-1a42899"><a href="#training-configs">Training Configs</a></h2> <h3 id="lora-configs" data-svelte-h="svelte-g6o2fl"><a href="#lora-configs">LoRa Configs</a></h3> <p data-svelte-h="svelte-jubdze">LoRa comes in various types, including LoRA-C3Lier, LoHa, and DyLoRA. Each type alters the kernel size of the 2D convolution layer and makes adjustments to the architecture. You can find more information on the internet. For this project, I’ll be using Kohya’s standard LoRa, which has been renamed as ‘LoRA-LierLa’. Two specific configurations need to be set for this model:</p> <p data-svelte-h="svelte-wn8m8a"><strong>network_dim:</strong> The network dimensions, or rank, indicates how many parameters of the Unet/TE to train. The higher the value, the greater the “expressive power” of the model, but at the expense of larger file size. Most of the time 64 is suffice if you want to train something generic. However, when dealing with more specialized subjects 128 is a better choice. In the case of medical images, I choose my rank as 128.</p> <p data-svelte-h="svelte-7ss2tj"><strong>network_alpha:</strong> Network alpha is like a learning control knob – it’s there to put the brakes on or, in other words, dampen the learning process. Essentially, it’s used to adjust the model’s weights during saving to prevent any rounding errors that might mess up some of the weight values.
Setting alpha to 0 or making it equal to network dimensions (net dim) doesn’t apply any dampening. However, when set to 1, it introduces significant dampening, requiring more training steps or a higher learning rate. A comparison of different scaling options is provided below:</p> <p data-svelte-h="svelte-d8n9bc">Alpha 0 = Alpha 128 = 128/128 = x1</p> <p data-svelte-h="svelte-wraidd">Alpha 1 = 1/128 = x0.0078125</p> <p data-svelte-h="svelte-14xjptv">Alpha 64 = 64/128 = x0.5</p> <p data-svelte-h="svelte-vq5j03">Alpha 128 = 128/128 = x1</p> <p data-svelte-h="svelte-le9wnw">Alpha 256 = 256/128 = x2</p> <p data-svelte-h="svelte-1utr4tu">When in doubt, you can set it equal to the network_dim.</p> <h3 id="optimizer-configs" data-svelte-h="svelte-1unxndu"><a href="#optimizer-configs">Optimizer Configs</a></h3> <p data-svelte-h="svelte-8k4f1a">In my opinion, AdamW stands out as one of the best optimizers available for this task, provided your system can handle the computational cost. If you’re working with budget constraints, an alternative optimizer to consider is Adafactor. It uses less memory by only storing partial information from previous gradients. Another solid choice is the 8-bit version of AdamW, known as AdamW8bit.</p> <p data-svelte-h="svelte-mp3fq0">As a note, AdamW8bit performed better than Adafactor in my case. However, I encourage you to experiment and explore options to see what works best for your particular project.</p> <p data-svelte-h="svelte-3jwbjp">As learning rate, I think it is also highly dependent on what you are trying to achieve. I have seen that the value of it can range anywhere from 4e-7, which is the standard learning rate for SDXL, to 8e-5. It is highly dependent on the dataset. If you are trying to teach a usual concept like a person, it is safe to increase it. However, if you are trying to teach a more unique concept, like medical images, lowering it down will be more beneficial. And don’t forget that as you decrease the learning rate, you have to train the model longer.</p> <p data-svelte-h="svelte-vs9pe3">I use a constant learning rate scheduler with a warm-up period of 100 steps. While some people recommend the cosine learning rate scheduler for better performance, I believe it can be a bit of a trial-and-error process to find the right fit for your dataset.</p> <h3 id="general-config" data-svelte-h="svelte-h48yzs"><a href="#general-config">General Config</a></h3> <p data-svelte-h="svelte-pu4xd9">For my other configurations, I typically set the number of repeats to 1 while aiming to maximize the number of epochs. There’s a parameter that determines how frequently the training script saves snapshots of the current model status. This periodic saving also triggers an inference run on the model with a predefined input prompt for testing. I monitor the generated images closely to determine whether LoRa is ready for the task. If it starts producing images with noticeable artifacts, it’s usually a sign of overfitting.</p> <h1 id="results-and-discussion" data-svelte-h="svelte-1mea2hz"><a href="#results-and-discussion">Results and Discussion</a></h1> <p data-svelte-h="svelte-i0347t">I trained several LoRa models. I used different learning rates, optimizers, and schedulers that I talked about through this blog post. Finally, I achieved some satisfactory results.</p> <center data-svelte-h="svelte-ltf103"><img src="img/melanomasynthetic.webp" alt="synthetic melanoma" width="480"></center>
For inference I used:
<ul data-svelte-h="svelte-1cryeho"><li>Sampler: Eular a, DPM++ 2M/3M Karras</li></ul> <ul data-svelte-h="svelte-esytgg"><li>20-30 Sampling steps</li> <li>7.5-9 CFG Scale</li></ul> <p data-svelte-h="svelte-19pf8j9">When I applied to the ABCDE rule that we talked about in <a href="#medical-image-synthesis">medical images section</a> to the synthesized images, I have seen that the most of the generations passed the test. However, when I looked at carefully for some images, I have seen that some of them are little blurry like the lower right corner. I think the reason for that could be the dataset.</p> <p data-svelte-h="svelte-1oojx0n">Following that, I decided to present a set of synthetic images to a group of professionals I am acquainted with. I explained the process and asked them to distinguish the synthetic images from the real ones. After examining the images, we engaged in a discussion about their observations and methodology. The professionals mentioned that they often perceived an image as synthetic when it exhibited fewer details. However, there was a complication as some real images in the dataset were quite simple and were mistakenly labeled as synthetic. Additionally, they encountered challenges when some complex synthetic images, which included elements like hair or red dots, were incorrectly identified as real by the examiners.</p> <p data-svelte-h="svelte-2tg79o">The results are promising, though not perfect at this stage. To further this project, collaboration with pathologists and dermatologists is essential. I firmly believe that the application of diffusion models in generating synthetic medical images holds great potential in this field.</p> <p data-svelte-h="svelte-1ryvyx5">Remarkably, I find it quite astonishing that by simply fine-tuning with LoRa, we are able to generate medical images. This process has shown a realm of new exciting possibilities for me. It’s especially significant due to the remarkably low costs involved, both in terms of system resources and time. Additionally, the compact model weights make it convenient to store and re-train various LoRas, offering substantial versatility for various applications.</p> <h1 id="references-and-notes" data-svelte-h="svelte-13qnvhc"><a href="#references-and-notes">References and Notes</a></h1> <p data-svelte-h="svelte-phek9b">All the code I wrote can be found in this <a href="https://github.com/lioga/melanoma-stable-diffusion" rel="nofollow noopener noreferrer external" target="_blank">repo</a>.</p> <div class="footnotes" data-svelte-h="svelte-16le02p"><hr> <ol><li id="fn-1">In order to achieve that task at least some amount of data is required to train generative AI model.<a href="#fnref-1" class="footnote-backref">↩</a></li> <li id="fn-2">Chen, R.J., Lu, M.Y., Chen, T.Y. <em>et al.</em> Synthetic data in machine learning for medicine and healthcare. <em>Nat Biomed Eng</em> <strong>5</strong>, 493–497 (2021). <a href="https://doi.org/10.1038/s41551-021-00751-8" rel="nofollow noopener noreferrer external" target="_blank">https://doi.org/10.1038/s41551-021-00751-8</a><a href="#fnref-2" class="footnote-backref">↩</a></li> <li id="fn-3"><a href="https://arxiv.org/abs/2208.12242" rel="nofollow noopener noreferrer external" target="_blank">https://arxiv.org/abs/2208.12242</a><a href="#fnref-3" class="footnote-backref">↩</a></li> <li id="fn-4"><a href="https://arxiv.org/abs/2106.09685" rel="nofollow noopener noreferrer external" target="_blank">https://arxiv.org/abs/2106.09685</a><a href="#fnref-4" class="footnote-backref">↩</a></li> <li id="fn-5">Rotemberg, V., Kurtansky, N., Betz-Stablein, B., Caffery, L., Chousakos, E., Codella, N., Combalia, M., Dusza, S., Guitera, P., Gutman, D., Halpern, A., Helba, B., Kittler, H., Kose, K., Langer, S., Lioprys, K., Malvehy, J., Musthaq, S., Nanda, J., Reiter, O., Shih, G., Stratigos, A., Tschandl, P., Weber, J. &amp; Soyer, P. A patient-centric dataset of images and metadata for identifying melanomas using clinical context. Sci Data 8, 34 (2021). <a href="https://doi.org/10.1038/s41597-021-00815-z" rel="nofollow noopener noreferrer external" target="_blank">https://doi.org/10.1038/s41597-021-00815-z</a><a href="#fnref-5" class="footnote-backref">↩</a></li> <li id="fn-6"><a href="https://arxiv.org/abs/2010.05351" rel="nofollow noopener noreferrer external" target="_blank">https://arxiv.org/abs/2010.05351</a><a href="#fnref-6" class="footnote-backref">↩</a></li></ol></div></main> <div class="divider mt-4 mb-0"></div> <div><a href="/?tags=Stable-Diffusion" class="btn btn-sm btn-ghost normal-case mt-2 mr-2 p-category">#Stable-Diffusion </a><a href="/?tags=Medical" class="btn btn-sm btn-ghost normal-case mt-2 mr-2 p-category">#Medical </a><a href="/?tags=Image-Synthesis" class="btn btn-sm btn-ghost normal-case mt-2 mr-2 p-category">#Image-Synthesis </a></div></div>  </article> <footer id="footer" class="footer footer-center bg-base-300 text-base-content shadow-inner p-8 md:rounded-box sticky bottom-0 z-0 md:static "><div class="prose"><p>
      Copyright © 2023 Behlul Akbudak <br>
      Template by
      <a rel="noopener noreferrer external" target="_blank" class="tooltip tooltip-secondary hover:text-secondary" data-tip="🌸 [δ] - Based on MDsveX & SvelteKit 🌸" href="https://github.com/importantimport/urara" data-svelte-h="svelte-urea7w">Urara</a> </p></div></footer></div></div></div> 
			<script type="application/json" data-sveltekit-fetched data-url="/posts.json">{"status":200,"statusText":"","headers":{},"body":"[{\"title\":\"Medical Image Synthesis with SDXL\",\"summary\":\"How I Synthesized Medical Melanoma Images with Stable Diffusion and LoRa\",\"created\":\"2023-11-02T00:00:00.000Z\",\"updated\":\"2023-11-02T00:00:00.000Z\",\"tags\":[\"Stable-Diffusion\",\"Medical\",\"Image-Synthesis\"],\"toc\":[{\"depth\":1,\"title\":\"Melanoma Skin Cancer\",\"slug\":\"melanoma-skin-cancer\"},{\"depth\":2,\"title\":\"Melanoma in People of Color\",\"slug\":\"melanoma-in-people-of-color\"},{\"depth\":2,\"title\":\"Key Indicators of Melanoma\",\"slug\":\"key-indicators-of-melanoma\"},{\"depth\":1,\"title\":\"Medical Image Synthesis\",\"slug\":\"medical-image-synthesis\"},{\"depth\":1,\"title\":\"Stable Diffusion\",\"slug\":\"stable-diffusion\"},{\"depth\":1,\"title\":\"Fine-tuning Methods for SD\",\"slug\":\"fine-tuning-methods-for-sd\"},{\"depth\":4,\"title\":\"Traditional Naive Fine-tuning (NFT)\",\"slug\":\"traditional-naive-fine-tuning-nft\"},{\"depth\":4,\"title\":\"Dreambooth\",\"slug\":\"dreambooth\"},{\"depth\":4,\"title\":\"LoRa\",\"slug\":\"lora\"},{\"depth\":2,\"title\":\"Comparison\",\"slug\":\"comparison\"},{\"depth\":4,\"title\":\"Computational Perspective\",\"slug\":\"computational-perspective\"},{\"depth\":4,\"title\":\"Size on Disk\",\"slug\":\"size-on-disk\"},{\"depth\":4,\"title\":\"Why I Chose LoRa\",\"slug\":\"why-i-chose-lora\"},{\"depth\":4,\"title\":\"Fine-tuning Based on Your Goal\",\"slug\":\"fine-tuning-based-on-your-goal\"},{\"depth\":1,\"title\":\"Data Preparation\",\"slug\":\"data-preparation\"},{\"depth\":1,\"title\":\"Fine-tuning SD with LoRa\",\"slug\":\"fine-tuning-sd-with-lora\"},{\"depth\":2,\"title\":\"Base Model\",\"slug\":\"base-model\"},{\"depth\":2,\"title\":\"Note on Beauty Standards of Models\",\"slug\":\"note-on-beauty-standards-of-models\"},{\"depth\":2,\"title\":\"Training Configs\",\"slug\":\"training-configs\"},{\"depth\":3,\"title\":\"LoRa Configs\",\"slug\":\"lora-configs\"},{\"depth\":3,\"title\":\"Optimizer Configs\",\"slug\":\"optimizer-configs\"},{\"depth\":3,\"title\":\"General Config\",\"slug\":\"general-config\"},{\"depth\":1,\"title\":\"Results and Discussion\",\"slug\":\"results-and-discussion\"},{\"depth\":1,\"title\":\"References and Notes\",\"slug\":\"references-and-notes\"}],\"images\":[],\"slug\":\"/synthetic-melanoma-images/+page.md\",\"path\":\"/synthetic-melanoma-images\",\"type\":\"article\",\"html\":\"\"},{\"title\":\"About Me\",\"created\":\"2023-10-19T00:00:00.000Z\",\"updated\":\"2023-10-19T00:00:00.000Z\",\"toc\":false,\"flags\":[\"unlisted\"],\"images\":[],\"tags\":[],\"slug\":\"/about/+page.md\",\"path\":\"/about\",\"type\":\"article\",\"html\":\"\"},{\"title\":\"Synthetic Data | Overview\",\"summary\":\"What is Synthetic Data, Where to Use It and How to Generate It\",\"created\":\"2023-10-19T00:00:00.000Z\",\"updated\":\"2023-10-19T00:00:00.000Z\",\"tags\":[\"Drone\",\"Autonomous\",\"Image-Synthesis\"],\"toc\":[{\"depth\":1,\"title\":\"What is Synthetic Data?\",\"slug\":\"what-is-synthetic-data\"},{\"depth\":1,\"title\":\"Where is Synthetic Data Used?\",\"slug\":\"where-is-synthetic-data-used\"},{\"depth\":1,\"title\":\"Why Synthetic Data is Important?\",\"slug\":\"why-synthetic-data-is-important\"},{\"depth\":1,\"title\":\"How to Generate Synthetic Data\",\"slug\":\"how-to-generate-synthetic-data\"},{\"depth\":2,\"title\":\"Game Engine Method\",\"slug\":\"game-engine-method\"},{\"depth\":2,\"title\":\"Generative AI Method\",\"slug\":\"generative-ai-method\"},{\"depth\":2,\"title\":\"Game Engine + Generative AI Method\",\"slug\":\"game-engine--generative-ai-method\"},{\"depth\":1,\"title\":\"Conclusion\",\"slug\":\"conclusion\"},{\"depth\":1,\"title\":\"Notes\",\"slug\":\"notes\"}],\"images\":[],\"slug\":\"/synthetic-data/+page.md\",\"path\":\"/synthetic-data\",\"type\":\"article\",\"html\":\"\"},{\"title\":\"Creating Magnificent PCBs at Home\",\"summary\":\"PCB manufacturing with mixture of toner transfer and dry film methods\",\"created\":\"2023-10-18T00:00:00.000Z\",\"updated\":\"2023-11-02T00:00:00.000Z\",\"tags\":[\"PCB\"],\"toc\":false,\"images\":[],\"slug\":\"/pcb-manufacturing/+page.md\",\"path\":\"/pcb-manufacturing\",\"type\":\"article\",\"html\":\"\"}]"}</script>
			<script>
				{
					__sveltekit_1pf1661 = {
						base: new URL("..", location).pathname.slice(0, -1),
						env: {}
					};

					const element = document.currentScript.parentElement;

					const data = [null,null];

					Promise.all([
						import("../_app/immutable/entry/start.bff7916a.js"),
						import("../_app/immutable/entry/app.bb691d3d.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 6],
							data,
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
  </body>
</html>
